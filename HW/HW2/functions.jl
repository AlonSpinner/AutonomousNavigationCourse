module ModelsAndScenario
using Revise
using Distributions
using Random
using LinearAlgebra
using Parameters

export POMDPscenario, PropagateBelief, 
        PropagateUpdateBelief, 
        SampleMotionModel, 
        GenerateObservation,
        GenerateObservationFromBeacons

const STATE_SIZE = 2
const I2 = Matrix{Float64}(I(STATE_SIZE))

@with_kw mutable struct POMDPscenario
    F::Array{Float64, 2}   
    H::Array{Float64, 2}
    Î£w::Array{Float64, 2}
    Î£v::Array{Float64, 2}
    rng::MersenneTwister
    beacons::Array{Float64, 2}
    d::Float64
    rmin::Float64
end


function PropagateBelief(b::FullNormal, ğ’«::POMDPscenario, a::Array{Float64, 1})::FullNormal
    
    Î¼b, Î£b = b.Î¼, b.Î£
    F  = ğ’«.F
    Î£w, Î£v = ğ’«.Î£w, ğ’«.Î£v
    
    # predict
    Î¼p = F * Î¼b  + a
    Î£p = F * Î£b * F' + Î£w
    return MvNormal(Î¼p, Î£p)
end 


function PropagateUpdateBelief(b::FullNormal, ğ’«::POMDPscenario, a::Array{Float64, 1}, z::Array{Float64, 1})::FullNormal
    # kalman filter litrature from probobalistic robotics
    Î¼b, Î£b = b.Î¼, b.Î£
    F  = ğ’«.F
    H  = ğ’«.H
    Î£w, Î£v = ğ’«.Î£w, ğ’«.Î£v
    
    # kalman predict
    Î¼p = F * Î¼b  + a
    Î£p = F * Î£b * F' + Î£w
    # update
    K = Î£p * H' * inv(H*Î£p*H'+Î£v)
    Î¼bâ€² = Î¼p + K*(z-H*Î¼p) 
    Î£bâ€² = (I - K*H)*Î£p
    return MvNormal(Î¼bâ€², Î£bâ€²)
end    

function SampleMotionModel(ğ’«::POMDPscenario, a::Array{Float64, 1}, x::Array{Float64, 1})
    noise = rand(ğ’«.rng,MvNormal([0;0],ğ’«.Î£w))
    xâ€² = ğ’«.F * x + a + noise
    return xâ€²
end 

function GenerateObservation(ğ’«::POMDPscenario, x::Array{Float64, 1})
    noise = rand(ğ’«.rng,MvNormal([0,0],ğ’«.Î£v))
    xâ€² = ğ’«.H * x + noise
    return xâ€²
end   


function GenerateObservationFromBeacons(ğ’«::POMDPscenario, x::Array{Float64, 1})::Union{NamedTuple, Nothing}
    distances = # calculate distances from x to all beacons
    for (index, distance) in enumerate(distances)
        if distance <= ğ’«.d
            obs = # add your code for creating observation here 
            return (obs=obs, index=index) 
        end    
    end 
    return nothing    
end    

end #module